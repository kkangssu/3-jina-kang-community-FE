name: Frontend CD

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy-az-a:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Deploy to AZ-A
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST_AZ_A_FRONTEND }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting deployment on AZ-A..."
          
          # ECR ë¡œê·¸ì¸
          aws ecr get-login-password --region ap-northeast-2 | \
            docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          
          # ìµœì‹  ì´ë¯¸ì§€ pull
          docker pull ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:latest
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          docker stop frontend-app || true
          docker rm frontend-app || true
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d \
            --name frontend-app \
            --restart unless-stopped \
            -p 80:80 \
            -e API_GATEWAY_URL=${{ secrets.API_GATEWAY_URL }} \
            -e BACKEND_HOST=${{ secrets.BACKEND_HOST_AZ_A }} \
            ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:latest
          
          # í—¬ìŠ¤ ì²´í¬ ëŒ€ê¸°
          echo "â³ Waiting for application to start..."
          sleep 15
          
          # í—¬ìŠ¤ ì²´í¬
          if curl -f http://localhost:80/health; then
            echo "âœ… Deployment successful on AZ-A!"
          else
            echo "âŒ Health check failed on AZ-A"
            exit 1
          fi
          
          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f
          
          echo "ğŸ‰ Deployment completed on AZ-A"
  
  deploy-az-b:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Deploy to AZ-B
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST_AZ_B_FRONTEND }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting deployment on AZ-B..."
          
          # ECR ë¡œê·¸ì¸
          aws ecr get-login-password --region ap-northeast-2 | \
            docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          
          # ìµœì‹  ì´ë¯¸ì§€ pull
          docker pull ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:latest
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          docker stop frontend-app || true
          docker rm frontend-app || true
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d \
            --name frontend-app \
            --restart unless-stopped \
            -p 80:80 \
            -e API_GATEWAY_URL=${{ secrets.API_GATEWAY_URL }} \
            -e BACKEND_HOST=${{ secrets.BACKEND_HOST_AZ_B }} \
            ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:latest
          
          # í—¬ìŠ¤ ì²´í¬ ëŒ€ê¸°
          echo "â³ Waiting for application to start..."
          sleep 15
          
          # í—¬ìŠ¤ ì²´í¬
          if curl -f http://localhost:80/health; then
            echo "âœ… Deployment successful on AZ-B!"
          else
            echo "âŒ Health check failed on AZ-B"
            exit 1
          fi
          
          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f
          
          echo "ğŸ‰ Deployment completed on AZ-B"