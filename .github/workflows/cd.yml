name: Frontend CD

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    strategy:
      matrix:
        include:
          - az: AZ-A
            host: ${{ secrets.EC2_HOST_AZ_A_FRONTEND }}
          - az: AZ-B
            host: ${{ secrets.EC2_HOST_AZ_B_FRONTEND }}
    
    steps:
    - name: Deploy to ${{ matrix.az }}
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ matrix.host }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting deployment on ${{ matrix.az }}..."
          
          # ECR ë¡œê·¸ì¸
          aws ecr get-login-password --region ap-northeast-2 | \
            docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          
          # ìµœì‹  ì´ë¯¸ì§€ pull
          docker pull ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:latest
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          docker stop frontend-app || true
          docker rm frontend-app || true
          
          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
          docker run -d \
            --name frontend-app \
            --restart unless-stopped \
            -p 80:80 \
            ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:latest
          
          # í—¬ìŠ¤ ì²´í¬ ëŒ€ê¸°
          echo "â³ Waiting for application to start..."
          sleep 15
          
          # í—¬ìŠ¤ ì²´í¬
          if curl -f http://localhost:80/health; then
            echo "âœ… Deployment successful on ${{ matrix.az }}!"
          else
            echo "âŒ Health check failed on ${{ matrix.az }}"
            exit 1
          fi
          
          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f
          
          echo "ğŸ‰ Deployment completed on ${{ matrix.az }}"